# v3.800.17
# https://virtocommerce.atlassian.net/browse/VCST-2789
name: Docker image vulnerability process

on:
  workflow_call:
    inputs:
      assigneeAccountId:
        description: 'Assignee account ID'
        required: true
        type: string
        default: '621c47c0302c6b006af0a1cd'
      assigneeEmailAddress:
        description: 'Assignee email address'
        required: true
        type: string
        default: 'andrew.kubyshkin@virtoworks.com'
      exitCodeOnFoundVulnerabilities:
        description: 'Exit code on found vulnerabilities. Non-zero value will fail the workflow.'
        required: false
        type: string
        default: '1'
      imageRef:
        description: 'Image reference'
        required: true
        type: string
        default: 'ghcr.io/virtocommerce/platform'
      imageTag:
        description: 'Image tag'
        required: true
        type: string
        default: 'dev-linux-latest'
      imageTarName:
        description: 'Image tarball path'
        required: false
        type: string
        default: 'image.tar'
      jiraBaseUrl:
        description: 'Jira Base Url'
        required: false
        type: string
        default: 'https://virto.atlassian.net'
      jiraProject:
        description: 'Jira Project'
        required: true
        type: string
      trivyMode:
        description: 'Trivy mode. "normal" - scan the image from the registry, "tarball" - scan the image from the tarball.'
        required: false
        type: string
        default: 'normal'
      trivySeverity:
        description: 'Trivy severity'
        required: false
        type: string
        default: 'CRITICAL,HIGH'
      vulnerabilitySkipList:
        description: 'List of vulnerabilities to skip (comma separated list of vulnerabilities)'
        required: false
        type: string
        default: ''

    secrets:
      JIRA_USER:
        required: true
      JIRA_TOKEN:
        required: true

jobs:
  scan-and-process:
    runs-on: ubuntu-22.04
    steps:
      - name: Scan Docker image from registry
        if: ${{ inputs.trivyMode == 'normal' }}
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ inputs.imageRef }}:${{ inputs.imageTag }}
          format: 'json'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: ${{ inputs.trivySeverity }}
          output: './${{ inputs.imageTag }}.json'
      
      - name: Download Docker image from tarball
        if: ${{ inputs.trivyMode == 'tarball' }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.imageTarName }}
          path: './${{ inputs.imageTarName }}'

      - name: List Docker image tarball
        if: ${{ inputs.trivyMode == 'tarball' }}
        run: |
          ls -la './${{ inputs.imageTarName }}'

      - name: Scan Docker image from tarball
        if: ${{ inputs.trivyMode == 'tarball' }}
        uses: aquasecurity/trivy-action@master
        with:
          input: './${{ inputs.imageTarName }}/${{ inputs.imageTag }}.tar'
          format: 'json'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: ${{ inputs.trivySeverity }}
          output: './${{ inputs.imageTag }}.json'

      - name: Publish result artifact
        uses: actions/upload-artifact@v4
        with:
          name: '${{ inputs.imageTag }}.json'
          path: './${{ inputs.imageTag }}.json'

      - name: Create Jira tickets for vulnerabilities if not exist
        shell: pwsh
        env:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
        run: |
          $jiraBaseUrl = "${{ inputs.jiraBaseUrl }}"
          $jiraUser = $env:JIRA_USER
          $jiraToken = $env:JIRA_TOKEN
          $jiraProject = "${{ inputs.jiraProject }}"
          if ("${{ inputs.vulnerabilitySkipList }}" -ne '') {
            $vulnerabilitySkipList = $(${{ inputs.vulnerabilitySkipList }}).Split(',')
          }
          else {
            $vulnerabilitySkipList = @()
          }
          $assigneeAccountId = "${{ inputs.assigneeAccountId }}"
          $assigneeEmailAddress = "${{ inputs.assigneeEmailAddress }}"
          $vulnerabilities = $(get-content './${{ inputs.imageTag }}.json' -Raw | ConvertFrom-Json).Results.Vulnerabilities
          $vulnerabilities = $vulnerabilities | Where-Object { $null -ne $_.VulnerabilityID }
          if ($vulnerabilities.Count -eq 0) {
            Write-Host "No '${{ inputs.trivySeverity }}' level vulnerabilities found in the image '${{ inputs.imageRef }}:${{ inputs.imageTag }}'"
            exit 0
          }
          ## Create Jira auth header
          $base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$jiraUser`:$jiraToken"))
          $headers = @{
              "Authorization" = "Basic $base64AuthInfo"
              "Content-Type"  = "application/json"
          }
          foreach ($vulnerability in $vulnerabilities) {
            # check for skip list
            if ($vulnerabilitySkipList -contains $vulnerability.VulnerabilityID) {
                Write-Host "The vulnerabilityID '$($vulnerability.VulnerabilityID)' is skipped as it presents in the skip list"
                continue
            }
            else {
                $jiraKey = "[Vulnerability] $($vulnerability.VulnerabilityID)"
                $body = @{
                    fields     = @("key")
                    jql        = "project = $jiraProject and summary ~ '$jiraKey'"
                    maxResults = 10
                } | ConvertTo-Json -Depth 100
                # check for Jira ticket existence
                try {
                    $issueExists = Invoke-RestMethod -Uri "$jiraBaseUrl/rest/api/3/search/jql" -Headers $headers -Method Post -Body $body
                    if ($issueExists.issues.count -gt 0) {
                        Write-Host "üîç Found $($issueExists.issues.count) task(s) with summary '$jiraKey'. Skipping creation..."
                        Write-Host "üîç Existing task(s) key(s): $($issueExists.issues.key)"
                        continue
                    }
                    else {
                        Write-Host "‚úÖ The task '$jiraKey' not found. Creating new task..."
                    }
                }
                catch {
                    Write-Host "‚ùå Failed to check the task $jiraKey. Error: $($_.ErrorDetails.Message)"
                }
            }
            # create missing tickets
            if ($issueExists.issues.count -eq 0) {
                try {
                    $body = @{
                        fields = @{
                            labels      = @("Vulnerability")
                            summary     = "$jiraKey"
                            project     = @{
                                key = "$jiraProject"
                            }
                            issuetype   = @{ name = "Task" }
                            assignee    = @{
                                accountId    = $assigneeAccountId
                                emailAddress = $assigneeEmailAddress
                            }
                            description = @{
                                type    = "doc"
                                version = 1
                                content = @(
                                    @{
                                        type    = "paragraph"
                                        content = @(
                                            @{
                                                type = "text"
                                                text = "*** Automatic vulnerability ticket created from Trivy scanner ***"
                                            },
                                            @{
                                                type    = "text"
                                                text    = "`nWorkflow run`n"
                                                "marks" = @(
                                                    @{
                                                        type  = "link"
                                                        attrs = @{
                                                            href = "https://github.com/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)"
                                                        }
                                                    }
                                                )
                                            },
                                            @{
                                                type = "text"
                                                text = "Title:`n    $($vulnerability.Title)`nDescription:`n    $($vulnerability.Description)`nSeverity:`n    $($vulnerability.Severity)`nCweIDs:`n    $($vulnerability.CweIDs)`nPublished:`n    $($vulnerability.PublishedDate)`nCVE URL:`n    "
                                            },
                                            @{
                                                type    = "text"
                                                text    = "$($vulnerability.PrimaryURL)"
                                                "marks" = @(
                                                    @{
                                                        type  = "link"
                                                        attrs = @{
                                                            href = "$($vulnerability.PrimaryURL)"
                                                        }
                                                    }
                                                )
                                            }
                                        )
                                    }
                                )
                            }
                        }
                    } | ConvertTo-Json -Depth 100
                    # $createdIssue = Invoke-RestMethod -Uri "$jiraBaseUrl/rest/api/3/issue" -Headers $headers -Method Post -Body $body
                    Write-Host "‚úÖ The task '$($createdIssue.key)' created with id '$($createdIssue.id)'."
                    Start-Sleep -Seconds 3
                }
                catch {
                    Write-Host "‚ùå Failed to create the task $jiraKey. Error: $($_.Exception.Message)"
                }
            }
          }
          if (${{ inputs.exitCodeOnFoundVulnerabilities }} -ne 0) {
            Write-Host "‚ùå Found vulnerabilities. Exiting with code ${{ inputs.exitCodeOnFoundVulnerabilities }}"
            exit ${{ inputs.exitCodeOnFoundVulnerabilities }}
          }
          else {
            Write-Host "‚ùå Found vulnerabilities, but configured to exit with code 0."
            exit 0
          }